# Phase 01.1: CI/CD Pipeline - Research

**Researched:** 2026-03-01
**Domain:** GitHub Actions CI/CD for Next.js + Bun + Supabase
**Confidence:** HIGH

## Summary

The Nhẩm project (GitHub repo `VoMinhKhoii/Nham`) has no CI/CD pipeline. All quality checks (Biome, ESLint, TypeScript, Vitest, Next.js build) are run manually. The project is deployed to Vercel (which handles production builds automatically) but has no pre-merge quality gate. This phase adds a GitHub Actions workflow that runs on PRs and pushes to `main`, covering lint → type-check → test → build.

The pipeline should use **GitHub Actions** with `oven-sh/setup-bun@v2` for Bun setup and `biomejs/setup-biome@v2` for Biome setup. Bun's built-in dependency caching via `setup-bun` makes CI fast. Tests split into two categories: unit tests (Vitest with jsdom, no secrets needed) and DB integration tests (require `DATABASE_URL` — run only on `main` or with explicit opt-in). Supabase migration deployment is handled separately via Vercel + Supabase GitHub integration or manual `supabase db push`.

**Primary recommendation:** Single workflow file with parallel jobs for lint, type-check, test, and build. DB integration tests as an optional job gated on secrets availability.

## Standard Stack

### Core

| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| GitHub Actions | v2 YAML | CI/CD orchestration | Native to GitHub; free for public repos, generous free tier for private |
| `oven-sh/setup-bun@v2` | v2 | Install Bun in CI | Official Bun action; auto-detects version from `package.json`, built-in caching |
| `biomejs/setup-biome@v2` | v2 | Install Biome CLI in CI | Official Biome action; auto-detects version from lockfile/`biome.json` schema |

### Supporting

| Tool | Purpose | When to Use |
|------|---------|-------------|
| `actions/checkout@v4` | Checkout repository | Every job |
| GitHub Actions cache | Cache `node_modules` / Bun global cache | Implicit via `setup-bun` |
| GitHub branch protection rules | Require status checks before merge | After workflow is created |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| GitHub Actions | Vercel CI (automatic) | Vercel already builds on deploy but has no lint/test/type-check steps; GH Actions is the quality gate |
| `biomejs/setup-biome@v2` | `bunx @biomejs/biome check .` | Dedicated action is faster (direct binary download, no npm install overhead) |
| Separate jobs per check | Single sequential job | Parallel jobs finish faster but use more minutes; for a solo dev project, parallel is still within free tier |

## Architecture Patterns

### Recommended Workflow Structure

```
.github/
└── workflows/
    └── ci.yml          # Single workflow, multiple parallel jobs
```

### Pattern 1: Parallel Job Matrix

**What:** Each quality check (lint, type-check, test, build) runs as an independent parallel job. Failures are visible per-check in the PR UI.

**When to use:** When checks are independent and you want fast feedback + clear failure attribution.

**Example:**

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: biomejs/setup-biome@v2
      - run: biome ci .

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bunx tsc --noEmit

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build
```

### Pattern 2: Concurrency Control

**What:** Cancel in-progress runs when new commits are pushed to the same branch/PR.

**When to use:** Always — prevents wasting CI minutes on superseded commits.

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

### Pattern 3: Frozen Lockfile Install

**What:** Use `bun install --frozen-lockfile` in CI to ensure reproducible installs.

**When to use:** Always in CI — prevents accidental dependency changes.

### Anti-Patterns to Avoid

- **Running all checks sequentially in one job:** Slower, harder to identify which check failed. Use parallel jobs.
- **Installing dependencies in every step:** Use one `bun install` step per job; Bun caches automatically.
- **Running DB integration tests without secrets:** The `search-pipeline.test.ts` requires `DATABASE_URL` pointing to live Supabase. Either skip these in CI or gate behind secrets.
- **Caching `node_modules` manually:** `oven-sh/setup-bun@v2` handles Bun's global cache automatically. Manual `node_modules` caching is redundant.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Bun installation in CI | Shell script to download Bun | `oven-sh/setup-bun@v2` | Handles caching, version detection, platform differences |
| Biome binary in CI | `bunx @biomejs/biome` (re-downloads every run) | `biomejs/setup-biome@v2` | Direct binary download, faster, cached |
| Dependency caching | Manual `actions/cache` for `~/.bun/install/cache` | `setup-bun`'s built-in caching | Automatic, correctly keyed to lockfile |
| PR status enforcement | Manual review checklists | GitHub branch protection rules | Automated, cannot be bypassed |

**Key insight:** GitHub Actions has mature first-party and official community actions for every tool in this stack. No custom scripting needed.

## Common Pitfalls

### Pitfall 1: Biome `check` vs `ci` Command

**What goes wrong:** Using `biome check` in CI — it exits 0 even with fixable issues when auto-fix is enabled locally.
**Why it happens:** `biome check` is designed for local use with `--write`. 
**How to avoid:** Use `biome ci` in GitHub Actions — it's the CI-specific command that reports errors without applying fixes and returns non-zero on any issue.
**Warning signs:** CI passes but local `biome check` shows issues.

### Pitfall 2: ESLint AND Biome Overlap

**What goes wrong:** Running both `bun lint` (ESLint) and `biome ci` catches overlapping issues, confusing developers with duplicate or conflicting reports.
**Why it happens:** Both tools check formatting and some lint rules. The project has both configured.
**How to avoid:** Run both in CI since they serve complementary purposes — ESLint handles Next.js-specific rules (`eslint-config-next/core-web-vitals`, `eslint-config-next/typescript`) while Biome handles formatting and general JS/TS linting. They don't truly conflict — ESLint covers Next.js patterns Biome doesn't know about.
**Warning signs:** If a rule fires in both tools, consider disabling it in one.

### Pitfall 3: DB Tests Need Live Supabase

**What goes wrong:** `search-pipeline.test.ts` fails in CI because `DATABASE_URL` is not available.
**Why it happens:** These tests run against the remote Supabase database, not a local mock.
**How to avoid:** Either (a) exclude DB tests in CI with a Vitest project config or test path filter, or (b) add `DATABASE_URL` as a GitHub Actions secret and run DB tests only on `main` branch pushes. Option (a) is simpler and recommended for v1.
**Warning signs:** Test job fails with connection errors.

### Pitfall 4: Next.js Build Requires Environment Variables

**What goes wrong:** `next build` may fail or produce warnings if `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` are missing.
**Why it happens:** Next.js inlines `NEXT_PUBLIC_*` vars at build time. If missing, runtime code referencing them may break.
**How to avoid:** Provide dummy/placeholder values for `NEXT_PUBLIC_*` vars in the build job's environment. These are only used for static analysis during build; actual values come from Vercel's environment.
**Warning signs:** Build warnings about missing environment variables, or runtime errors in built output.

### Pitfall 5: Bun Lockfile Mismatch

**What goes wrong:** `bun install --frozen-lockfile` fails because `bun.lock` is out of sync with `package.json`.
**Why it happens:** Developer added a dependency but didn't commit the updated lockfile.
**How to avoid:** The frozen lockfile flag catches this automatically — it's the point. Just fix the lockfile locally and push.
**Warning signs:** CI install step fails with lockfile error.

## Code Examples

### Complete CI Workflow

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (Biome)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: biomejs/setup-biome@v2
      - run: biome ci .

  eslint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bunx tsc --noEmit

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun test
    # Note: bun test runs `vitest run` which uses the include pattern
    # '**/__tests__/**/*.test.{ts,tsx}' — this includes DB tests that
    # need DATABASE_URL. Either exclude them via a filter or add the secret.

  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: "placeholder"
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build
```

### Excluding DB Tests in CI

To exclude DB integration tests that require `DATABASE_URL`, modify the test command:

```yaml
# Option A: Exclude specific test directory
- run: bun vitest run --exclude '**/lib/db/__tests__/**'

# Option B: Use environment variable to conditionally skip
- run: bun test
  env:
    SKIP_DB_TESTS: "true"
```

Or use a Vitest workspace/project config to separate unit vs integration tests.

### Branch Protection Setup (manual step)

After the workflow is deployed, configure branch protection in GitHub:
1. Go to repo Settings → Branches → Add rule for `main`
2. Check "Require status checks to pass before merging"
3. Select the CI job names: `Lint (Biome)`, `Lint (ESLint)`, `Type Check`, `Test`, `Build`
4. Optionally check "Require branches to be up to date before merging"

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `actions/setup-node` + npm | `oven-sh/setup-bun@v2` | Bun 1.0 (Sep 2023) | 2-3x faster installs, native TS execution |
| Manual Biome binary download | `biomejs/setup-biome@v2` | Biome 1.5+ (2024) | Auto-detects version from lockfile |
| `biome check --ci` flag | `biome ci` subcommand | Biome 1.x+ | Dedicated CI command, cleaner semantics |
| Complex caching with `actions/cache` | Built-in caching in `setup-bun` | setup-bun v2 | Zero-config, lockfile-keyed cache |

**Deprecated/outdated:**
- `biome check --ci` flag: Replaced by `biome ci` subcommand
- Manual `actions/cache` for Bun: `setup-bun@v2` handles this automatically

## Deployment Considerations

### Vercel (Next.js App)

Vercel is already configured for the project. It automatically:
- Builds on push to `main` (production) and PR branches (preview)
- Handles environment variables via its dashboard
- No additional CI/CD step needed for deployment

The GitHub Actions workflow is a **quality gate before merge**, not a deployment pipeline. Vercel handles deployment independently.

### Supabase Migrations

Supabase migrations live in `supabase/migrations/`. Options for CI:
1. **Manual via CLI** (current): `supabase db push` run locally after merge
2. **Supabase GitHub Integration**: Automatically applies migrations on push to `main`
3. **GitHub Actions step**: Run `supabase db push` in a post-merge job with `SUPABASE_ACCESS_TOKEN` and `SUPABASE_DB_PASSWORD` secrets

For a solo developer project, option 1 (manual) or option 2 (Supabase GitHub Integration) is sufficient. Automated migration deployment in CI adds complexity without proportional benefit at this scale.

**Recommendation:** Keep migration deployment manual for now. Focus CI on quality gates only. Supabase GitHub Integration can be enabled later if needed.

## Open Questions

1. **DB Integration Tests in CI**
   - What we know: `search-pipeline.test.ts` requires `DATABASE_URL` (live Supabase). Unit tests (4 other test files) don't need it.
   - What's unclear: Whether the solo developer wants to expose `DATABASE_URL` as a GitHub secret or simply exclude DB tests.
   - Recommendation: Exclude DB tests from CI for now (`--exclude` flag). They can be added later when a CI-specific Supabase branch database is set up.

2. **ESLint vs Biome Redundancy**
   - What we know: Both ESLint and Biome are configured. ESLint covers Next.js-specific rules; Biome covers formatting + general linting.
   - What's unclear: Whether running both is desired or if one should be dropped.
   - Recommendation: Run both in CI — they're complementary. ESLint catches Next.js-specific issues Biome doesn't cover.

3. **`NEXT_PUBLIC_*` Build Variables**
   - What we know: `next build` needs `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` at build time.
   - What's unclear: Whether the build will hard-fail or just warn without them.
   - Recommendation: Provide placeholder values in the CI build job. The real build happens on Vercel with actual values.

## Sources

### Primary (HIGH confidence)
- `oven-sh/setup-bun` README (GitHub) — Bun CI setup, caching, version detection
- `biomejs/setup-biome` README (GitHub) — Biome CI setup, auto-version detection
- Project `package.json` — scripts, dependencies, Bun 1.3.2
- Project `biome.json` — Biome 2.4.2 configuration
- Project `vitest.config.ts` — test configuration, include patterns
- Project `tsconfig.json` — TypeScript configuration
- Project `.env.local` — required environment variable names

### Secondary (MEDIUM confidence)
- GitHub Actions workflow syntax — well-documented, stable API
- `biome ci` subcommand behavior — verified against Biome docs

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — GitHub Actions + setup-bun + setup-biome are all official, well-documented tools
- Architecture: HIGH — Parallel job pattern is standard GitHub Actions best practice
- Pitfalls: HIGH — Based on direct analysis of project's actual config files and test structure

**Research date:** 2026-03-01
**Valid until:** 2026-04-01 (stable tooling, unlikely to change)
