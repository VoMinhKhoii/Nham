---
phase: 01-database-schema-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - supabase/migrations/_add_meals_weight_tables.sql
autonomous: true
requirements:
  - DB-02
  - DB-03
  - DB-04

must_haves:
  truths:
    - "A meal record can be inserted with JSONB bounded nutrition data (low/mid/high per macro) and retrieved correctly"
    - "Meal items link to both a parent meal and a food composition row with per-item adjusted nutrition bounds"
    - "A body weight entry can be inserted and queried by user and date, with one-entry-per-day upsert semantics"
    - "Unmatched ingredient queries are logged with context for future DB expansion"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "Drizzle table definitions for meals, mealItems, bodyWeightLog, unmatchedIngredients"
      exports: ["meals", "mealItems", "bodyWeightLog", "unmatchedIngredients"]
    - path: "supabase/migrations/*_add_meals_weight_tables.sql"
      provides: "DDL migration creating meals, meal_items, body_weight_log, unmatched_ingredients tables"
  key_links:
    - from: "meals.user_id"
      to: "auth.users.id"
      via: "foreign key with cascade delete"
      pattern: "REFERENCES.*auth.*users.*ON DELETE cascade"
    - from: "meal_items.meal_id"
      to: "meals.id"
      via: "foreign key with cascade delete"
      pattern: "REFERENCES.*meals.*ON DELETE cascade"
    - from: "meal_items.food_composition_id"
      to: "vietnamese_food_composition.id"
      via: "nullable foreign key (null = unmatched ingredient)"
      pattern: "REFERENCES.*vietnamese_food_composition"
    - from: "body_weight_log(user_id, logged_date)"
      to: "unique constraint"
      via: "one entry per user per day"
      pattern: "UNIQUE.*user_id.*logged_date"
---

<objective>
Define Drizzle ORM table schemas for meals, meal_items, body_weight_log, and unmatched_ingredients, then generate the Supabase migration.

Purpose: Establish the core data structures that all subsequent phases (AI pipeline, meal logging, weight tracking, analytics) build on. Without these tables, no feature can persist data.

Output: Updated `lib/db/schema.ts` with 4 new table exports; one Drizzle-generated migration SQL file in `supabase/migrations/`.
</objective>

<execution_context>
@/Users/khoivo/.copilot/get-shit-done/workflows/execute-plan.md
@/Users/khoivo/.copilot/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema-infrastructure/01-CONTEXT.md

@lib/db/schema.ts
@lib/db/index.ts
@drizzle.config.ts
@supabase/migrations/20260224095657_setup_user_profiles.sql
@supabase/migrations/20260226172553_add_food_composition.sql

<interfaces>
<!-- Existing Drizzle schema exports the executor will extend -->
From lib/db/schema.ts:
```typescript
// Reference to Supabase auth schema (reuse for FKs)
const authSchema = pgSchema('auth');
const authUsers = authSchema.table('users', { id: uuid('id').primaryKey() });

export const userProfiles = pgTable('user_profiles', { ... });
export const vietnameseFoodComposition = pgTable('vietnamese_food_composition', { ... });
```

From lib/db/index.ts:
```typescript
import * as schema from './schema';
export const db = drizzle(client, { schema });
```

Drizzle imports already used in schema.ts:
```typescript
import { sql } from 'drizzle-orm';
import { boolean, check, date, decimal, numeric, pgSchema, pgTable, smallint, text, timestamp, uuid } from 'drizzle-orm/pg-core';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define new table schemas in Drizzle</name>
  <files>lib/db/schema.ts</files>
  <action>
Add 4 new table exports to `lib/db/schema.ts`. Import additional column types needed: `jsonb`, `integer`, `real`, `unique`, `index`, `foreignKey` from `drizzle-orm/pg-core`.

**`meals` table:**
- `id` — uuid, primary key, default `gen_random_uuid()`
- `userId` — uuid, NOT NULL, FK to `authUsers.id` with cascade delete
- `rawInput` — text, NOT NULL (the user's natural language meal description)
- `mealSlot` — text, nullable (AI-classified: 'sang', 'trua', 'toi', 'bua_phu')
- `slotOverride` — boolean, default false (true if user manually changed the slot)
- `confidenceOverall` — text, nullable ('high', 'medium', 'low')
- `loggedAt` — timestamp with timezone, NOT NULL, default now()
- **Bounded nutrition columns** — each is `jsonb` storing `{low: number, mid: number, high: number}`:
  `caloriesKcal`, `proteinG`, `carbohydrateG`, `fatG`, `fiberG`,
  `sodiumMg`, `calciumMg`, `ironMg`, `magnesiumMg`, `phosphorusMg`,
  `potassiumMg`, `zincMg`, `copperMcg`, `manganeseMg`,
  `betaCaroteneMcg`, `vitaminAMcg`, `vitaminDMcg`, `vitaminEMg`,
  `vitaminKMcg`, `vitaminCMg`, `vitaminB1Mg`, `vitaminB2Mg`,
  `vitaminPpMg`, `vitaminB5Mg`, `vitaminB6Mg`, `vitaminB9Mcg`,
  `vitaminB12Mcg`, `vitaminHMcg`
  (Column names in DB match `vietnamese_food_composition` column names exactly, e.g., `calories_kcal`, `protein_g`)
- `createdAt` — timestamp with timezone, NOT NULL, default now()
- `updatedAt` — timestamp with timezone, NOT NULL, default now()
- CHECK constraint: `meal_slot` IN ('sang', 'trua', 'toi', 'bua_phu')
- CHECK constraint: `confidence_overall` IN ('high', 'medium', 'low')
- Index on `(user_id, logged_at)` for daily queries

**`mealItems` table:**
- `id` — uuid, primary key, default `gen_random_uuid()`
- `mealId` — uuid, NOT NULL, FK to `meals.id` with cascade delete
- `foodCompositionId` — text, nullable, FK to `vietnameseFoodComposition.id` with set null (null = unmatched)
- `ingredientName` — text, NOT NULL (display name from AI extraction)
- `estimatedGrams` — real, nullable (weight in grams)
- `userFacingUnit` — text, nullable (e.g., "1 chén", "2 miếng")
- `cookingMethod` — text, nullable (e.g., "chiên", "luộc", "hấp")
- `matchConfidence` — real, nullable (0.0–1.0 score from vector search)
- **Bounded nutrition columns** — same JSONB pattern as meals table, same column names
- `createdAt` — timestamp with timezone, NOT NULL, default now()

**`bodyWeightLog` table:**
- `id` — uuid, primary key, default `gen_random_uuid()`
- `userId` — uuid, NOT NULL, FK to `authUsers.id` with cascade delete
- `loggedDate` — date, NOT NULL
- `weightKg` — numeric(5,2), NOT NULL
- `createdAt` — timestamp with timezone, NOT NULL, default now()
- UNIQUE constraint on `(user_id, logged_date)` — enables upsert (one entry per day)

**`unmatchedIngredients` table:**
- `id` — uuid, primary key, default `gen_random_uuid()`
- `mealId` — uuid, nullable, FK to `meals.id` with set null
- `queryText` — text, NOT NULL (the extracted ingredient name that failed to match)
- `mealContext` — text, nullable (the full meal description for context)
- `createdAt` — timestamp with timezone, NOT NULL, default now()

Use the same patterns as existing tables: `sql` template literals for check constraints, reference `authUsers` for user FKs, reference `vietnameseFoodComposition` for food composition FK. Use `gen_random_uuid()` via `sql\`gen_random_uuid()\`` for default UUIDs.
  </action>
  <verify>
    <automated>cd /Users/khoivo/Documents/nham && npx tsc --noEmit lib/db/schema.ts 2>&1 | head -20</automated>
  </verify>
  <done>lib/db/schema.ts exports `meals`, `mealItems`, `bodyWeightLog`, `unmatchedIngredients` with all columns, constraints, and foreign keys as specified. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Generate Drizzle migration</name>
  <files>supabase/migrations/_add_meals_weight_tables.sql</files>
  <action>
Run `bun run db:generate` to create the migration SQL from the updated Drizzle schema. This runs `bunx drizzle-kit generate` which reads `drizzle.config.ts` (schema: `./lib/db/schema.ts`, output: `./supabase/migrations`).

After generation:
1. Verify the new migration file exists in `supabase/migrations/`
2. Read the generated SQL and confirm it contains:
   - `CREATE TABLE "meals"` with all JSONB nutrition columns and check constraints
   - `CREATE TABLE "meal_items"` with FK references to meals and vietnamese_food_composition
   - `CREATE TABLE "body_weight_log"` with unique constraint on (user_id, logged_date)
   - `CREATE TABLE "unmatched_ingredients"` with FK to meals
   - All foreign key `ALTER TABLE ... ADD CONSTRAINT` statements
3. If the generated SQL is missing constraints or has issues, make corrections to `lib/db/schema.ts` and regenerate

Do NOT manually edit the generated migration file — it is Domain A (Drizzle-managed). If corrections are needed, fix the schema source and regenerate.
  </action>
  <verify>
    <automated>cd /Users/khoivo/Documents/nham && ls -la supabase/migrations/*_add_meals* 2>/dev/null || ls -la supabase/migrations/ | tail -5</automated>
  </verify>
  <done>A new migration file exists in `supabase/migrations/` containing CREATE TABLE statements for all 4 new tables with correct column types, constraints, foreign keys, and indexes. The migration is generated by Drizzle (not hand-written).</done>
</task>

</tasks>

<verification>
1. `lib/db/schema.ts` compiles: `npx tsc --noEmit lib/db/schema.ts`
2. New migration file exists in `supabase/migrations/` with timestamp prefix
3. Migration SQL contains CREATE TABLE for: meals, meal_items, body_weight_log, unmatched_ingredients
4. meals table has JSONB columns for all nutrients matching vietnamese_food_composition column names
5. meal_items has FK to both meals (cascade) and vietnamese_food_composition (set null)
6. body_weight_log has UNIQUE constraint on (user_id, logged_date)
7. All user-facing tables have user_id FK to auth.users with cascade delete
</verification>

<success_criteria>
- 4 new Drizzle table definitions exported from `lib/db/schema.ts`
- 1 new Drizzle-generated migration in `supabase/migrations/`
- TypeScript compilation passes
- Generated SQL matches the schema specification from CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-schema-infrastructure/01-01-SUMMARY.md`
</output>
